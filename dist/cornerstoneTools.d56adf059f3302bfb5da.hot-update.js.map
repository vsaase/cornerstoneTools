{"version":3,"sources":["webpack://cornerstoneTools/./tools/segmentation/InterpolationTool.js"],"names":["logger","getLogger","segmentationModule","getModule","InterpolationTool","props","defaultProps","name","supportedInteractionTypes","configuration","mixins","evt","_startPainting","getters","setters","eventData","detail","element","image","rows","columns","stackState","getToolState","stackData","data","imageIds","labelmap2D","labelmap3D","currentImageIdIndex","activeLabelmapIndex","imagesInRange","Array","from","length","v","k","paintEventData","storeHistory","previousPixeldataForImagesInRange","i","imageIdIndex","labelmap2DForImageIdIndex","labelmap2DByImageIdIndex","previousPixeldata","pixelData","slice","push","currentPoints","x","y","getPixelData","getSegmentArray","p1","map","activeSegmentIndex","setSegmentArray","console","log","changecount","changecandidates","reduce","a","b","j","interpolate","i1","i2","v1","v2","d","vnext","vi","external","cornerstone","updateImage","operations","labelmaps2D","segmentSet","Set","iterator","values","segmentsOnLabelmap","done","next","value","newPixelData","diff","getDiffBetweenPixelData","pushState","triggerLabelmapModifiedEvent","BaseTool"],"mappings":"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","file":"cornerstoneTools.d56adf059f3302bfb5da.hot-update.js","sourcesContent":["import external from './../../externalModules.js';\nimport BaseTool from './../base/BaseTool.js';\nimport { getModule } from './../../store/index.js';\nimport { triggerLabelmapModifiedEvent } from './../../util/segmentation';\nimport { getToolState } from '../../stateManagement/toolState.js';\nimport { getLogger } from '../../util/logger.js';\nimport { getDiffBetweenPixelData } from '../../util/segmentation';\n\nconst logger = getLogger('tools:InterpolationTool');\n\nconst segmentationModule = getModule('segmentation');\n\n/**\n * @public\n * @class InterpolationTool\n * @memberof Tools\n * @classdesc Tool for interpolating between segments across images.\n * @extends Tools.Base.BaseTool\n */\nexport default class InterpolationTool extends BaseTool {\n  constructor(props = {}) {\n    const defaultProps = {\n      name: 'Interpolation',\n      supportedInteractionTypes: ['Mouse', 'Touch'],\n      configuration: {},\n      mixins: [],\n    };\n\n    super(props, defaultProps);\n  }\n\n  preMouseDownCallback(evt) {\n    this._startPainting(evt);\n\n    return true;\n  }\n\n  /**\n   *\n   * @abstract\n   * @event\n   * @param {Object} evt - The event.\n   * @returns {void}\n   */\n  _startPainting(evt) {\n    const { configuration, getters, setters } = segmentationModule;\n    const eventData = evt.detail;\n    const { element, image } = eventData;\n    const { rows, columns } = image;\n\n    const stackState = getToolState(element, 'stack');\n    const stackData = stackState.data[0];\n    const { imageIds } = stackData;\n\n    const {\n      labelmap2D,\n      labelmap3D,\n      currentImageIdIndex,\n      activeLabelmapIndex,\n    } = getters.labelmap2D(element);\n\n    let imagesInRange = Array.from(\n      { length: imageIds.length },\n      (v, k) => k + 1\n    );\n\n    this.paintEventData = {\n      labelmap2D,\n      labelmap3D,\n      currentImageIdIndex,\n      activeLabelmapIndex,\n      imagesInRange,\n    };\n\n    if (configuration.storeHistory) {\n      const previousPixeldataForImagesInRange = [];\n\n      for (let i = 0; i < imagesInRange.length; i++) {\n        const { imageIdIndex } = imagesInRange[i];\n        const labelmap2DForImageIdIndex = getters.labelmap2DByImageIdIndex(\n          labelmap3D,\n          imageIdIndex,\n          rows,\n          columns\n        );\n\n        const previousPixeldata = labelmap2DForImageIdIndex.pixelData.slice();\n\n        previousPixeldataForImagesInRange.push(previousPixeldata);\n      }\n\n      this.paintEventData.previousPixeldataForImagesInRange = previousPixeldataForImagesInRange;\n    }\n\n    const { x, y } = eventData.currentPoints.image;\n\n    if (x < 0 || x > columns || y < 0 || y > rows) {\n      return;\n    }\n\n    function getPixelData(i) {\n      const labelmap2DForImageIdIndex = getters.labelmap2DByImageIdIndex(\n        labelmap3D,\n        i,\n        rows,\n        columns\n      );\n      return labelmap2DForImageIdIndex.pixelData;\n    }\n\n    function getSegmentArray(i) {\n      const p1 = getPixelData(i);\n      return p1.map(x => x == labelmap3D.activeSegmentIndex);\n    }\n\n    function setSegmentArray(i, v) {\n      console.log('setting image ' + i);\n      var p1 = getPixelData(i);\n      var changecount = 0;\n      var changecandidates = v.reduce((a, b) => a + b, 0);\n      for (let j = 0; j < p1.length; j++) {\n        if (v[j] && p1[j] != labelmap3D.activeSegmentIndex) {\n          changecount++;\n        }\n        p1[j] = v[j] ? labelmap3D.activeSegmentIndex : p1[j];\n      }\n      console.log('changed ' + changecount + ' pixels of ' + changecandidates);\n    }\n\n    /* Algorithm for interpolation\n      find first image i1 with active segment\n      save segment as binary vector v1\n\n      until i2 > imagesInRange\n        find next image i2 with active segment\n        save segment as binary vector v2\n        d = i2 - i1\n        if d > 1\n          for i in i1+1 to i2-1\n            for j in 1:length(v1)\n              if v1[j] * (i2 - i)/d + v2[j] * (i - i1)/d > 0.5\n                v[j] = activesegment\n        v1 = v2\n        i1 = i2\n    */\n\n    function interpolate(i, i1, i2, v1, v2) {\n      const d = i2 - i1;\n      return v1.map(\n        (x, j) => (x * (i2 - i)) / d + (v2[j] * (i - i1)) / d >= 0.5\n      );\n      // var out = v1.slice();\n      // for (let j = 0; j < out.length; j++) {\n      //   out[j] = (v1[j] * (i2 - i)) / d + (v2[j] * (i - i1)) / d;\n      // }\n      // return out.map(Math.round);\n    }\n\n    let i1 = 0;\n    while (i1 < imagesInRange.length - 2) {\n      //find first image i1 with active segment\n      const v1 = getSegmentArray(i1); // get segment as binary vector v1\n      if (v1.reduce((a, b) => a + b, 0) == 0) {\n        //empty, try next\n        i1++;\n        continue;\n      }\n      const vnext = getSegmentArray(i1 + 1);\n      if (vnext.reduce((a, b) => a + b, 0) > 0) {\n        //next is not empty, no need to interpolate\n        i1++;\n        continue;\n      }\n      let i2 = i1 + 2;\n      while (i2 < imagesInRange.length) {\n        // find next image i2 with active segment\n        const v2 = getSegmentArray(i2);\n        if (v2.reduce((a, b) => a + b, 0) == 0) {\n          //empty, try next\n          i2++;\n          continue;\n        }\n        for (let i = i1 + 1; i < i2; i++) {\n          const vi = interpolate(i, i1, i2, v1, v2);\n          setSegmentArray(i, vi);\n        }\n        break;\n      }\n      i1 = i2;\n    }\n\n    external.cornerstone.updateImage(evt.detail.element);\n    const operations = [];\n\n    for (let i = 0; i < imagesInRange.length; i++) {\n      const { imageIdIndex } = imagesInRange[i];\n      const labelmap2D = labelmap3D.labelmaps2D[imageIdIndex];\n\n      // Grab the labels on the slice.\n      const segmentSet = new Set(labelmap2D.pixelData);\n      const iterator = segmentSet.values();\n\n      const segmentsOnLabelmap = [];\n      let done = false;\n\n      while (!done) {\n        const next = iterator.next();\n\n        done = next.done;\n\n        if (!done) {\n          segmentsOnLabelmap.push(next.value);\n        }\n      }\n\n      labelmap2D.segmentsOnLabelmap = segmentsOnLabelmap;\n\n      if (configuration.storeHistory) {\n        const { previousPixeldataForImagesInRange } = this.paintEventData;\n\n        const previousPixeldata = previousPixeldataForImagesInRange[i];\n        const labelmap2D = labelmap3D.labelmaps2D[imageIdIndex];\n        const newPixelData = labelmap2D.pixelData;\n\n        operations.push({\n          imageIdIndex,\n          diff: getDiffBetweenPixelData(previousPixeldata, newPixelData),\n        });\n      }\n    }\n\n    if (configuration.storeHistory) {\n      setters.pushState(this.element, operations);\n    }\n\n    triggerLabelmapModifiedEvent(this.element);\n    console.log(labelmap3D);\n  }\n}\n"],"sourceRoot":""}